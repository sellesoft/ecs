/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => P4Integration
});
module.exports = __toCommonJS(main_exports);
var import_obsidian = require("obsidian");
var import_util = require("util");
var import_child_process = require("child_process");
var pexec = (0, import_util.promisify)(import_child_process.exec);
var DEFAULT_SETTINGS = {};
var debounce = (callback, wait) => {
  let timeout_id;
  return (...args) => {
    window.clearTimeout(timeout_id);
    timeout_id = window.setTimeout(() => {
      callback(...args);
    }, wait);
  };
};
var P4Integration = class extends import_obsidian.Plugin {
  constructor() {
    super(...arguments);
    this.file_map = /* @__PURE__ */ new Map();
  }
  async editOrAddFile(path, name) {
    let result = await this.execP4Command("edit", path);
    if (result.stdout.length != 0) {
      if (result.stdout.match(/(?<!currently )opened for edit/))
        new import_obsidian.Notice(`checked out ${name}`);
    }
    if (result.stderr.length != 0) {
      if (result.stderr.match(/file\(s\) not on client/)) {
        let result2 = await this.execP4Command("add", path);
        if (result2.stdout.match(/(?<!already )opened for add/)) {
          new import_obsidian.Notice(`marked ${name} for add`);
        }
      }
    }
  }
  // Invoked when the user (or something programatically) makes a change 
  // to the file currently open in the Editor.
  onEditorChange(editor, info) {
    if (info.file == null)
      return;
    const short_path = info.file.path;
    const full_path = `${this.fs.getBasePath()}/${short_path}`;
    let cb = this.file_map.get(full_path);
    if (cb == void 0) {
      cb = debounce(() => {
        this.editOrAddFile(full_path, short_path);
      }, 1e3);
      this.file_map.set(full_path, cb);
    }
    cb();
  }
  async onload() {
    await this.loadSettings();
    this.fs = this.app.vault.adapter;
    this.registerEvent(this.app.workspace.on(
      "editor-change",
      this.onEditorChange,
      this
    ));
    this.addCommand(
      {
        id: "p4-checkout",
        name: "P4 Checkout",
        editorCallback: (_, ctx) => {
          if (ctx.file != null)
            this.execP4Command("edit", ctx.file.path);
        }
      }
    );
    this.addCommand(
      {
        id: "p4-add",
        name: "P4 Add",
        editorCallback: (_, ctx) => {
          if (ctx.file != null)
            this.execP4Command("add", ctx.file.path);
        }
      }
    );
  }
  onunload() {
  }
  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }
  async saveSettings() {
    await this.saveData(this.settings);
  }
  // Executes a p4 command on the given path (which should be absolute).
  async execP4Command(cmd, path) {
    const cwd = this.fs.getBasePath();
    const env = process.env;
    const full_cmd = `p4 ${cmd} ${path}`;
    const result = await pexec(
      full_cmd,
      {
        cwd,
        env
      }
    );
    return result;
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IFxueyBcblx0RWRpdG9yLCBcblx0TWFya2Rvd25WaWV3LCBcblx0Tm90aWNlLCBcblx0UGx1Z2luLCBcblx0RmlsZVN5c3RlbUFkYXB0ZXIsXG59IGZyb20gJ29ic2lkaWFuJztcblxuLy8gRm9yIHJ1bm5pbmcgcDQuXG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICd1dGlsJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmNvbnN0IHBleGVjID0gcHJvbWlzaWZ5KGV4ZWMpXG5cbmludGVyZmFjZSBQNEludGVncmF0aW9uU2V0dGluZ3MgXG57XG59XG5cbmNvbnN0IERFRkFVTFRfU0VUVElOR1M6IFA0SW50ZWdyYXRpb25TZXR0aW5ncyA9IFxue1xufVxuXG5jb25zdCBkZWJvdW5jZSA9IChjYWxsYmFjazogYW55LCB3YWl0OiBudW1iZXIpID0+XG57XG5cdGxldCB0aW1lb3V0X2lkOiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cdHJldHVybiAoLi4uYXJnczogYW55W10pID0+XG5cdHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRfaWQpO1xuXHRcdHRpbWVvdXRfaWQgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PlxuXHRcdHtcblx0XHRcdGNhbGxiYWNrKC4uLmFyZ3MpO1xuXHRcdH0sIHdhaXQpXG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUDRJbnRlZ3JhdGlvbiBleHRlbmRzIFBsdWdpbiBcbntcblx0c2V0dGluZ3M6IFA0SW50ZWdyYXRpb25TZXR0aW5ncztcblx0ZnM6IEZpbGVTeXN0ZW1BZGFwdGVyO1xuXHRmaWxlX21hcDogTWFwPHN0cmluZywgKC4uLmFyZ3M6YW55W10pID0+IHZvaWQ+ID0gbmV3IE1hcCgpO1xuXG5cdGFzeW5jIGVkaXRPckFkZEZpbGUocGF0aDogc3RyaW5nLCBuYW1lOiBzdHJpbmcpXG5cdHtcblx0XHRsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5leGVjUDRDb21tYW5kKFwiZWRpdFwiLCBwYXRoKTtcblx0XG5cdFx0Ly8gQ2hlY2sgaWYgd2UganVzdCBvcGVuZWQgZm9yIGVkaXQuXG5cdFx0aWYgKHJlc3VsdC5zdGRvdXQubGVuZ3RoICE9IDApXG5cdFx0e1xuXHRcdFx0Ly8gQW5kIG5vdGlmeSBpZiBzby5cblx0XHRcdGlmIChyZXN1bHQuc3Rkb3V0Lm1hdGNoKC8oPzwhY3VycmVudGx5IClvcGVuZWQgZm9yIGVkaXQvKSlcblx0XHRcdFx0bmV3IE5vdGljZShgY2hlY2tlZCBvdXQgJHtuYW1lfWApXG5cdFx0fVxuXHRcdFxuXHRcdGlmIChyZXN1bHQuc3RkZXJyLmxlbmd0aCAhPSAwKVxuXHRcdHtcblx0XHRcdC8vIE90aGVyd2lzZSBtYXJrIGZvciBhZGQgaWYgZmlsZSBpcyB1bnZlcnNpb25lZC5cblx0XHRcdGlmIChyZXN1bHQuc3RkZXJyLm1hdGNoKC9maWxlXFwoc1xcKSBub3Qgb24gY2xpZW50LykpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmV4ZWNQNENvbW1hbmQoXCJhZGRcIiwgcGF0aClcblx0XHRcdFx0aWYgKHJlc3VsdC5zdGRvdXQubWF0Y2goLyg/PCFhbHJlYWR5IClvcGVuZWQgZm9yIGFkZC8pKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bmV3IE5vdGljZShgbWFya2VkICR7bmFtZX0gZm9yIGFkZGApXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblxuICAvLyBJbnZva2VkIHdoZW4gdGhlIHVzZXIgKG9yIHNvbWV0aGluZyBwcm9ncmFtYXRpY2FsbHkpIG1ha2VzIGEgY2hhbmdlIFxuICAvLyB0byB0aGUgZmlsZSBjdXJyZW50bHkgb3BlbiBpbiB0aGUgRWRpdG9yLlxuICBvbkVkaXRvckNoYW5nZShlZGl0b3I6IEVkaXRvciwgaW5mbzogTWFya2Rvd25WaWV3KVxuICB7XG5cdFx0aWYgKGluZm8uZmlsZSA9PSBudWxsKVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0Y29uc3Qgc2hvcnRfcGF0aCA9IGluZm8uZmlsZS5wYXRoO1xuXHRcdGNvbnN0IGZ1bGxfcGF0aCA9IGAke3RoaXMuZnMuZ2V0QmFzZVBhdGgoKX0vJHtzaG9ydF9wYXRofWA7XG5cblx0XHQvLyBUcnkgdG8gZ2V0IGEgcHJldmlvdXNseSBjcmVhdGVkIGRlYm91bmNlZCBjYWxsYmFjayBmb3IgY2FsbGluZyBpbnRvIFxuXHRcdC8vIHA0LiBXZSBkZWJvdW5jZSB0aGlzIHRvIGF2b2lkIHNlbmRpbmcgY29tbWFuZHMgdG8gcDQgb24gZXZlcnkga2V5c3Ryb2tlLlxuXHRcdGxldCBjYiA9IHRoaXMuZmlsZV9tYXAuZ2V0KGZ1bGxfcGF0aClcblx0XHRpZiAoY2IgPT0gdW5kZWZpbmVkKVxuXHRcdHtcblx0XHRcdC8vIENyZWF0ZSBhbmQgY2FjaGUgdGhlIGNhbGxiYWNrIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUgZm9yIHRoaXMgXG5cdFx0XHQvLyBmaWxlLlxuXHRcdFx0Y2IgPSBkZWJvdW5jZSgoKSA9PlxuXHRcdFx0e1xuXHRcdFx0XHR0aGlzLmVkaXRPckFkZEZpbGUoZnVsbF9wYXRoLCBzaG9ydF9wYXRoKVxuXHRcdFx0fSwgMTAwMClcblxuXHRcdFx0dGhpcy5maWxlX21hcC5zZXQoZnVsbF9wYXRoLCBjYilcblx0XHR9XG5cblx0XHRjYigpO1xuICB9XG5cblx0YXN5bmMgb25sb2FkKCkgXG5cdHtcblx0XHRhd2FpdCB0aGlzLmxvYWRTZXR0aW5ncygpO1xuXHRcdFxuXHRcdC8vIE9ic2lkaWFuIHByZWZlcnMgeW91IHVzZSB0aGVpciBWYXVsdCBhcGkgdG8gZGVhbCB3aXRoIGZpbGVzIGluIHRoZSBcblx0XHQvLyB2YXVsdCBhcyBpdCBjYW4gYmUgcnVuIG9uIG1vYmlsZSBhbmQgc3VjaC4gSG93ZXZlciwgdGhpcyBkb2VzIG5vdCBcblx0XHQvLyBwcm92aWRlIGFjY2VzcyB0byBhYnNvbHV0ZSBwYXRocyB0aGF0IHdlIG5lZWQgdG8gZ2l2ZSB0byBwNC5cblx0XHQvLyBTaW5jZSBwNCBpcyBub3Qgb24gbW9iaWxlLCB3ZSBqdXN0IGFzc3VtZSBkZXNrdG9wIGFuZCBnZXQgdGhlIHVuZGVybHlpbmdcblx0XHQvLyBGaWxlU3lzdGVtQWRhcHRlciBoZXJlLlxuXHRcdHRoaXMuZnMgPSB0aGlzLmFwcC52YXVsdC5hZGFwdGVyIGFzIEZpbGVTeXN0ZW1BZGFwdGVyO1xuXG5cdFx0Ly8gVE9ETyhzdXNoaSkgbWF5YmUgc29tZXRpbWUgYWRkIGEgc3RhdHVzIGZvciB0aGUgc3RhdGUgb2YgdGhlIGZpbGUgXG5cdFx0Ly8gICAgICAgICAgICAgdW5kZXIgcDQuXG5cdFx0Ly9cblx0XHQvLyBUaGlzIGFkZHMgYSBzdGF0dXMgYmFyIGl0ZW0gdG8gdGhlIGJvdHRvbSBvZiB0aGUgYXBwLiBcblx0XHQvLyBjb25zdCBzdGF0dXNCYXJJdGVtRWwgPSB0aGlzLmFkZFN0YXR1c0Jhckl0ZW0oKTtcblx0XHQvLyBzdGF0dXNCYXJJdGVtRWwuc2V0VGV4dCgnU3RhdHVzIEJhciBUZXh0Jyk7XG5cdFx0XG5cdFx0dGhpcy5yZWdpc3RlckV2ZW50KHRoaXMuYXBwLndvcmtzcGFjZS5vbignZWRpdG9yLWNoYW5nZScsIFxuXHRcdFx0XHR0aGlzLm9uRWRpdG9yQ2hhbmdlLCBcblx0XHRcdFx0dGhpcykpO1xuXG5cdFx0dGhpcy5hZGRDb21tYW5kKFxuXHRcdHtcblx0XHRcdGlkOiAncDQtY2hlY2tvdXQnLFxuXHRcdFx0bmFtZTogJ1A0IENoZWNrb3V0Jyxcblx0XHRcdGVkaXRvckNhbGxiYWNrOiAoXywgY3R4OiBNYXJrZG93blZpZXcpID0+IFxuXHRcdFx0eyBcblx0XHRcdFx0aWYgKGN0eC5maWxlICE9IG51bGwpXG5cdFx0XHRcdFx0dGhpcy5leGVjUDRDb21tYW5kKFwiZWRpdFwiLCBjdHguZmlsZS5wYXRoKTsgXG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHR0aGlzLmFkZENvbW1hbmQoXG5cdFx0e1xuXHRcdFx0aWQ6ICdwNC1hZGQnLFxuXHRcdFx0bmFtZTogJ1A0IEFkZCcsXG5cdFx0XHRlZGl0b3JDYWxsYmFjazogKF8sIGN0eDogTWFya2Rvd25WaWV3KSA9PiBcblx0XHRcdHsgXG5cdFx0XHRcdGlmIChjdHguZmlsZSAhPSBudWxsKVxuXHRcdFx0XHRcdHRoaXMuZXhlY1A0Q29tbWFuZChcImFkZFwiLCBjdHguZmlsZS5wYXRoKTsgXG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRvbnVubG9hZCgpIHsgfVxuXG5cdGFzeW5jIGxvYWRTZXR0aW5ncygpIFxuXHR7XG5cdFx0dGhpcy5zZXR0aW5ncyA9IFxuXHRcdFx0T2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9TRVRUSU5HUywgYXdhaXQgdGhpcy5sb2FkRGF0YSgpKTtcblx0fVxuXG5cdGFzeW5jIHNhdmVTZXR0aW5ncygpIFxuXHR7XG5cdFx0YXdhaXQgdGhpcy5zYXZlRGF0YSh0aGlzLnNldHRpbmdzKTtcblx0fVxuXG5cdC8vIEV4ZWN1dGVzIGEgcDQgY29tbWFuZCBvbiB0aGUgZ2l2ZW4gcGF0aCAod2hpY2ggc2hvdWxkIGJlIGFic29sdXRlKS5cblx0YXN5bmMgZXhlY1A0Q29tbWFuZChjbWQ6IHN0cmluZywgcGF0aDogc3RyaW5nKVxuXHR7XG5cdFx0Y29uc3QgY3dkID0gdGhpcy5mcy5nZXRCYXNlUGF0aCgpO1xuXHRcdGNvbnN0IGVudiA9IHByb2Nlc3MuZW52O1xuXG5cdFx0Y29uc3QgZnVsbF9jbWQgPSBgcDQgJHtjbWR9ICR7cGF0aH1gO1xuXG5cdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgcGV4ZWMoZnVsbF9jbWQsXG5cdFx0e1xuXHRcdFx0Y3dkOiBjd2QsXG5cdFx0XHRlbnY6IGVudixcblx0XHR9KTtcblxuXHRcdHJldHVybiByZXN1bHRcblx0fVxufVxuXG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsc0JBT087QUFHUCxrQkFBMEI7QUFDMUIsMkJBQXFCO0FBQ3JCLElBQU0sWUFB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
