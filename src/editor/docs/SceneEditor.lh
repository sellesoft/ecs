/*
 *  A doc providing an editor for a scene.
 */

$ require "common"

@lpp.import "editor/Doc.lh"
@lpp.import "graphics/View.lh"
@lpp.import "sdata/SourceDataFile.lh"
@lpp.import "sdata/SourceDataEditor.lh"
@lpp.import "reflect/Packing.lh"
@lpp.import "game/shared/entity/EntityMgr.lh"
@lpp.import "game/shared/entity/Entity.defs.lh"
@lpp.import "game/client/graphics/GameRenderer.lh"
@lpp.import "game/client/entity/EntitySysMgr.lh"
@lpp.import "editor/Editor.lh"

namespace editor
{

/* ============================================================================
 */
struct SceneEditor : Doc
{
  cl::GameRenderer game_renderer;
  EntityMgr entity_mgr;
  cl::EntitySysMgr entity_sys_mgr;
  gfx::View view;
  GameLog game_log;

  gfx::Texture scene_render;

  reflect::PackedData scene_def_packed;
  SourceDataFile sdf_scene_def;

  // The size at which the scene view should be rendered, controlled
  // by the size of the ui quad we draw in putUI().
  vec2f view_size;

  SourceDataFile sdf_selected_entity_def;
  EntityDefLink selected_entity_def;

  SourceDataEditor sd_editor;

  b8 dragging_view;
  b8 dragging_entity;

  vec2f drag_start_world;
  vec2f drag_start_viewport;

  vec2f entity_select_pos_viewport;
  vec2f entity_select_pos_entity_local;

  EntityId selected_entity;
  EntityId hovered_entity;

  fs::PathBuffer placement_entity_def_path;
  EntityDefLink placement_entity_def;
  EntityId placement_entity;

  PlacementMode placement_mode;

  enum Tool
  {
    None,
    PaintTile,
  };

  Tool selected_tool;

  enum class EntityBuildState
  {
    None,
    Requested,
    Failed,
  };

  EntityBuildState entity_build_state;

  void onOpen() override { init(); }

  b8 init();
  void deinit();

  void putUI(ui::UI& ui, const EditorSkinDef& skin) override;
  void render(gfx::Vulkan& vk) override;

  vec2f viewportToWorld(vec2f point)
  {
    return view.viewportPointToWorld(point, view_size);
  }

  template<typename T>
  T& getSys()
  {
    return entity_sys_mgr.get<T>();
  }

  template<typename T>
  b8 link(rtr::TypeId type, String name, T* data)
  {
    return editor->getLinker().link(type, name, data);
  }
};

}
