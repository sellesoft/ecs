/*
 *  Testing for the packing pipeline.
 */

$ local cmn = require "common"

@lpp.import "reflect/Packing.lh"
@lpp.import "graphics/Texture.defs.lh"
@lpp.import "sdata/SourceDataFile.lh"
@lpp.import "sdata/SourceDataEditorSkin.defs.lh"

@lpp.import "Test.defs.lh"
@lpp.import "game/shared/entity/Entity.defs.lh"

@log.import

$ local sfile_path = "tests/packing/test.data"
$ local expected_type = "Basket"

b8 test()
{
  SourceDataFile testfile;
  if (!SourceDataFile::from(&testfile, "$(sfile_path)"_str))
    return false;
  defer { testfile.deinit(); };

  reflect::PackedData packed;
  if (!packed.init())
    return @log.error(test, "failed to initialize PackedData\n");
  defer { packed.deinit(); };

  reflect::PackParams pack_params = 
  {
    "$(sfile_path)"_str,
    &packed 
  };

  if (!reflect::packSourceDataFromType(*testfile.returned_data, pack_params))
    return false;

  auto* result = packed.getDataAs<$(expected_type)>();

  rtr::prettyPrint(*result);

  return true;
}

int main()
{
  return test()? 0 : 1;
}
